# WSL2 DNS failure
## DNS issue 

From WSL2 vm, I cannot ping google.ca or any site, 
```
oldhorse@wsl2:$ ping google.ca
ping: google.ca: Temporary failure in name resolution
```
However directly ping to ip is working, means routing is ok, 
```
oldhorse@wsl2:$ ping 172.217.13.163
PING 172.217.13.163 (172.217.13.163) 56(84) bytes of data.
64 bytes from 172.217.13.163: icmp_seq=1 ttl=105 time=60.5 ms
64 bytes from 172.217.13.163: icmp_seq=2 ttl=105 time=63.2 ms
^C
--- 172.217.13.163 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1002ms
rtt min/avg/max/mdev = 60.527/61.851/63.176/1.324 ms
```
further DNS test working via correct DNS server,
```
oldhorse@wsl2:$ host -t A google.ca 1.1.1.1
Using domain server:
Name: 1.1.1.1
Address: 1.1.1.1#53
Aliases:

google.ca has address 172.217.13.163

oldhorse@wsl2:$ host -t A google.ca 8.8.8.8
Using domain server:
Name: 8.8.8.8
Address: 8.8.8.8#53
Aliases:

google.ca has address 172.217.13.163
```
## default gateway 
 
let us have a look at current default gateway, 
```
oldhorse@wsl2:~$ cat /etc/resolv.conf
# This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateResolvConf = false
nameserver 172.26.128.1

oldhorse@wsl2:~$ ip addr show eth0
4: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 00:15:5d:6f:8c:7c brd ff:ff:ff:ff:ff:ff
    inet 172.26.129.37/20 brd 172.26.143.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::215:5dff:fe6f:8c7c/64 scope link
       valid_lft forever preferred_lft forever

oldhorse@wsl2:~$ ip route
default via 172.26.128.1 dev eth0
172.26.128.0/20 dev eth0 proto kernel scope link src 172.26.129.37
```
this default gateway is from host machine WSL adapter ip, 
```
Ethernet adapter vEthernet (WSL):

   Connection-specific DNS Suffix  . :
   Link-local IPv6 Address . . . . . : fe80::a58d:462c:523f:6517%77
   IPv4 Address. . . . . . . . . . . : 172.26.128.1
   Subnet Mask . . . . . . . . . . . : 255.255.240.0
   Default Gateway . . . . . . . . . :
```
WSL2 vm access to it without issue, 
```
oldhorse@wsl2:~$ ping 172.26.128.1
PING 172.26.128.1 (172.26.128.1) 56(84) bytes of data.
64 bytes from 172.26.128.1: icmp_seq=1 ttl=128 time=0.288 ms
```
## remedy 

It seems common issue for WSL2, no matter with VPN or without VPN.

As remedy I just add 1.1.1.1 and 8.8.8.8 to /etc/resolve.conf, then DNS issue gone.
```
oldhorse@wsl2:~$ cat /etc/resolv.conf
# This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateResolvConf = false
nameserver 172.26.128.1
nameserver 1.1.1.1
nameserver 8.8.8.8

oldhorse@wsl2:~$ ping google.ca
PING google.ca (172.217.13.163) 56(84) bytes of data.
64 bytes from yul03s04-in-f3.1e100.net (172.217.13.163): icmp_seq=1 ttl=105 time=61.6 ms
```
This is great but only temp remedy, it will be gone after WSL2 restart.

here is permanent fix:
1) disable to generate resolv.conf 
```
oldhorse@wsl2$ cat /etc/wsl.conf
[user]
default=oldhorse
[network]
generateResolvConf = false
```
2) backup /etc/resolv.conf
```
cp /etc/resolv.conf /etc/resolve.conf.backup
unlink /etc/resolv.conf
```
3) reboot WSL2
wsl -t Ubuntu-22.04 
4) manually create /etc/resolv.conf
nameserver 8.8.8.8

## conclusion
WSL2 is hyper-v based vm on win10/win11, even hyper-v component not necessary enabled, the DNS and routing way is totally different than WSL1.

There are tons of issues on this concern in https://github.com/microsoft/WSL/issues, but final solution not released so far.


